<!doctype html>
<html>
<head>
<meta charset="utf-8">
<script src="bower_components/webcomponentsjs/webcomponents.min.js"></script>
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/webaudio-controls/webaudio-controls.html" >
<link rel="import" href="webaudio-tinysynth.html" >
<link rel="import" href="webaudio-pianoroll.html" >
<style>
#soundeditor{
  display:none;
}
td{
  text-align: center;
}
</style>
<script>
var curProg=0;
var curNote=60;
var curMidi=0;
function Init(){
  actx=new AudioContext();
  synth=document.getElementById("tinysynth");
  kb=document.getElementById("kb");
  kb.addEventListener("change",KeyIn);
  var sh=document.getElementById("shot");
  for(var i=0;i<128;++i){
    var o=document.createElement("option");
    o.innerHTML=(i+1)+" : "+synth.program[i].name;
    document.getElementById("prog").appendChild(o);
  }
  sh.addEventListener("mousedown",function(){
    synth.send([0x90+curMidi,curNote,100],0);
  });
  sh.addEventListener("mouseup",function(){
    synth.send([0x80+curMidi,curNote,100],0);
  });
  timerid=setInterval(function(){					/* need to wait initialize for webcomponents polyfill */
    console.log("Initialize checking.");
    if(synth.setAudioContext){
      synth.setAudioContext(actx);
      clearInterval(timerid);
      ProgChange(0);
      console.log("Initialized");
    }
  },200);
}
function Ctrl(){
  if(typeof(synth)!="undefined"){
    synth.masterVol=document.getElementById("vol").value;
    synth.reverbLev=document.getElementById("rev").value;
  }
}
function KeyIn(e){
  curNote=e.note[1];
  document.getElementById("shot").innerHTML=curNote;
  if(e.note[0])
    synth.send([0x90+curMidi,e.note[1],100]);
  else
    synth.send([0x80+curMidi,e.note[1],0]);
  if(curMidi==9){
    var w=synth.drummap[e.note[1]-35];
    ViewParam(w);
  }
}
function ChChange(e){
  if(e.selectedIndex)
    curMidi=9;
  else
    curMidi=0;
}
function ViewDef(pg){
  var s=JSON.stringify(pg);
  s=s.replace("}",",}");
  s=s.replace(/\"name\":\"[-a-zA-Z0-9\(\) \+]*\",/,"");
  s=s.replace("\"w2\":\"\"","").replace(/\"(..)\"/g,"$1");
  s=s.replace(/..:null,/g,"");
  if(!pg.w2)
    s=s.replace(/.2:[0-9]*(,|})/g,"$1");
  s=s.replace("t1:1,",",").replace("f1:0,",",").replace("a1:0,",",").replace("b1:0,",",")
  .replace("h1:0.01,",",").replace("p1:1,",",").replace("r1:0.05,",",").replace("r2:0.05,",",");
  s=s.replace("f2:0,",",");
  s=s.replace(/,+/g,",");
  document.getElementById("patch").value=s;
}
function ViewParam(pg){
  if(!pg)
    return;
  document.getElementById("name").innerHTML=pg.name+" : ";
  pg=pg.w;
  document.getElementById("ag").value=pg.ag;

  document.getElementById("w1").value=pg.w1;
  document.getElementById("v1").value=pg.v1;
  document.getElementById("t1").value=pg.t1;
  document.getElementById("f1").value=pg.f1;
  document.getElementById("a1").value=pg.a1;
  document.getElementById("h1").value=pg.h1;
  document.getElementById("d1").value=pg.d1;
  document.getElementById("s1").value=pg.s1;
  document.getElementById("r1").value=pg.r1;
  document.getElementById("b1").value=pg.b1;
  document.getElementById("p1").value=pg.p1;

  document.getElementById("w2").value=pg.w2;
  document.getElementById("v2").value=pg.v2;
  document.getElementById("t2").value=pg.t2;
  document.getElementById("f2").value=pg.f2;
  document.getElementById("d2").value=pg.d2;
  document.getElementById("s2").value=pg.s2;
  document.getElementById("r2").value=pg.r2;
  document.getElementById("b2").value=pg.b2;

  ViewDef(pg);
}
function ProgChange(p){
  if(synth){
    synth.send([0xc0,p]);
    if(curMidi!=9){
      curProg=p;
      var pg=synth.program[curProg];
      ViewParam(pg);
    }
  }
}
function SetQuality(n){
  var pg;
  synth.quality=n;
  if(curMidi==9)
    pg=synth.drummap[curNote];
  else
    pg=synth.program[curProg];
  ViewParam(pg);
}
function GetVal(id){
  var s=+document.getElementById(id).value;
  if(isNaN(s))
    s=0;
  return s;
}
function OpenEditor(){
  var e=document.getElementById("soundeditor");
  if(e.style.display=="block")
    e.style.display="none";
  else
    e.style.display="block";
}
function Edit(){
  var prog;
  if(curMidi==9)
    prog=synth.drummap[curNote-35].w;
  else
    prog=synth.program[curProg].w;
  prog.ag=document.getElementById("ag").selectedIndex;
  prog.w1=document.getElementById("w1").value;
  prog.v1=GetVal("v1");
  prog.t1=GetVal("t1");
  prog.f1=GetVal("f1");
  prog.a1=GetVal("a1");
  prog.h1=GetVal("h1");
  prog.d1=GetVal("d1");
  prog.s1=GetVal("s1");
  prog.r1=GetVal("r1");
  prog.b1=GetVal("b1");
  prog.p1=GetVal("p1");
  prog.w2=document.getElementById("w2").value;
  prog.v2=GetVal("v2");
  prog.t2=GetVal("t2");
  prog.f2=GetVal("f2");
  prog.d2=GetVal("d2");
  prog.s2=GetVal("s2");
  prog.r2=GetVal("r2");
  prog.b2=GetVal("b2");
  ViewDef(prog);
}
window.onload=()=>{
  Init();
}

</script>
</head>
<body>
<h1>TinySynth Test Page</h1>
<b>webaudio-tinysynth</b> is a small GM like mapped synthesizer.<br/>
Repository : <a href="https://github.com/g200kg/webaudio-tinysynth">https://github.com/g200kg/webaudio-tinysynth</a>
<ul>
  <li>Polymer module. written in JavaScript</li>
  <li>playable with mouse or qwerty-keyboard.</li>
  <li>GM like timbre map. Ch10 is drum track.</li>
  <li>Quality setting switches two timbre set. light-weighted 1osc or FMbased 2osc</li>
  <li>built-in MIDI sequencer is also available. drag &amp; drop .mid file to TinySynth</li>
</ul>
<hr/>
<webaudio-keyboard id="kb" keys="73" min="35" width="800" tabindex="1"></webaudio-keyboard>
<br/>
Ch : <select onchange="ChChange(this)"><option>Ch1</option><option>Drum (Ch10)</option></select>
Prog : <select id="prog" onchange="ProgChange(this.selectedIndex)">
</select>
<hr/>
<webaudio-tinysynth id="tinysynth" quality="1"></webaudio-tinysynth>
<table>
<tr>
  <td><webaudio-knob diameter="40" min="0" max="1" step="0.01" id="vol" value="0.5" onchange="Ctrl()"></webaudio-knob></td>
  <td><webaudio-knob diameter="40" min="0" max="1" step="0.01" id="rev" value="0.5" onchange="Ctrl()"></webaudio-knob></td>
</tr>
<tr><td>Vol</td><td>Reverb</td></tr>
</table>
<hr/>
Quality : <select onchange="SetQuality(this.selectedIndex)"><option>0</option><option selected>1</option></select>
<br/>
<button onclick="synth.loadMIDIUrl('./websequencerdemo.mid')">Load Demo MIDI</button>
<hr/>
<button onclick="OpenEditor()">Sound Editor</button> <span id="name"></span><button id="shot"></button><br/>
<div id="soundeditor">
<table>
  <tr><td>AG</td></tr>
  <tr><td><select id="ag" onchange="Edit()"><option>0</option><option>1</option></select></td></tr>
  <tr><td>W1</td><td>V1</td><td>T1</td><td>F1</td><td>A1</td><td>H1</td><td>D1</td><td>S1</td><td>R1</td><td>B1</td><td>P1</td></tr>
  <tr>
  <td><select id="w1" onchange="Edit()"><option value="sine">sine</option><option value="sawtooth">sawtooth</option><option value="square">square</option><option value="triangle">triangle</option></select></td>
  <td><input id="v1"  oninput="Edit()" value="0.5" size="4"/></td>
  <td><input id="t1"  oninput="Edit()" value="0" size="4"/></td>
  <td><input id="f1"  oninput="Edit()" value="0" size="4"/></td>
  <td><input id="a1"  oninput="Edit()" value="0" size="4"/></td>
  <td><input id="h1"  oninput="Edit()" value="0" size="4"/></td>
  <td><input id="d1"  oninput="Edit()" value="0.1" size="4"/></td>
  <td><input id="s1"  oninput="Edit()" value="0" size="4"/></td>
  <td><input id="r1"  oninput="Edit()" value="0.1" size="4"/></td>
  <td><input id="b1"  oninput="Edit()" value="0" size="4"/></td>
  <td><input id="p1"  oninput="Edit()" value="0" size="4"/></td>
  </tr>
  <tr><td>W2</td><td>V2</td><td>T2</td><td>F2</td><td>D2</td><td>S2</td><td>R2</td><td>B2</td></tr>
  <tr>
  <td><select id="w2" onchange="Edit()"><option value=""></option><option value="sine">sine</option><option value="sawtooth">sawtooth</option><option value="square">square</option><option value="triangle">triangle</option></select></td>
  <td><input id="v2"  oninput="Edit()" value="0.5" size="4"/></td>
  <td><input id="t2"  oninput="Edit()" value="0.5" size="4"/></td>
  <td><input id="f2"  oninput="Edit()" value="0.5" size="4"/></td>
  <td><input id="d2"  oninput="Edit()" value="0" size="4"/></td>
  <td><input id="s2"  oninput="Edit()" value="0" size="4"/></td>
  <td><input id="r2"  oninput="Edit()" value="0" size="4"/></td>
  <td><input id="b2"  oninput="Edit()" value="0" size="4"/></td>
  </tr>
</table>
<br/>
<input id="patch" size="80"/>
</div>
<hr/>
</body>
</html>
